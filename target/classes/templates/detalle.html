<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title th:text="${titulo}">Detalle de Receta</title>
    
    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1>üç≥ Recetas Seguras</h1>
                </div>
                <nav class="nav">
                    <a th:href="@{/}" class="nav-link">Inicio</a>
                    <a th:href="@{/recetas/buscar}" class="nav-link">Buscar Recetas</a>
                    
                    <!-- Mostrar si el usuario est√° autenticado -->
                    <div sec:authorize="isAuthenticated()" class="user-menu-simple">
                        <span class="user-greeting">Hola, <span sec:authentication="name">Usuario</span>!</span>
                        <a th:href="@{/recetas/publicar}" class="nav-link">Publicar Receta</a>
                        <form th:action="@{/logout}" method="post" style="display: inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="nav-link logout-btn">Cerrar Sesi√≥n</button>
                        </form>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <!-- Detalle de la Receta -->
    <section class="detalle-section">
        <div class="container">
            
            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <a th:href="@{/}">Inicio</a> / 
                <a th:href="@{/recetas/buscar}">Buscar</a> / 
                <span th:text="${receta.nombre}">Receta</span>
            </div>

            <div class="receta-detalle">
                
                <!-- Cabecera -->
                <div class="receta-header">
                    <h1 th:text="${receta.nombre}">Nombre de la Receta</h1>
                    
                    <p class="receta-autor-detalle" th:if="${receta.autor != null}">
                        üë®‚Äçüç≥ Publicado por: <strong th:text="${receta.autor.nombreCompleto}">Autor</strong>
                    </p>
                    
                    <div class="receta-meta-info">
                        <span class="badge-large" th:text="${receta.dificultad}">Dificultad</span>
                        <span class="meta-item">üìç <span th:text="${receta.paisOrigen}">Pa√≠s</span></span>
                        <span class="meta-item">üç≥ <span th:text="${receta.tipoCocina}">Tipo</span></span>
                        <span class="meta-item">üëÅÔ∏è <span th:text="${receta.visualizaciones}">0</span> vistas</span>
                    </div>
                </div>

                <!-- Carrusel de im√°genes y videos -->
                <div class="receta-galeria">
                    <!-- Verificar si hay archivos multimedia en la nueva estructura -->
                    <div th:if="${receta.mediaFiles != null and !receta.mediaFiles.isEmpty()}" class="carousel-container">
                        <div class="carousel">
                            <div class="carousel-inner">
                                <div th:each="mediaFile, iterStat : ${receta.mediaFiles}" 
                                     class="carousel-item"
                                     th:classappend="${iterStat.index == 0} ? 'active' : ''">
                                    <!-- Mostrar video -->
                                    <video th:if="${mediaFile.mediaType == 'video'}" 
                                           th:src="${mediaFile.mediaUrl}" 
                                           controls 
                                           class="receta-video carousel-media">
                                        Tu navegador no soporta el elemento de video.
                                    </video>
                                    
                                    <!-- Mostrar imagen -->
                                    <img th:if="${mediaFile.mediaType == 'image'}"
                                         th:src="${mediaFile.mediaUrl}" 
                                         th:alt="${receta.nombre}"
                                         class="receta-imagen carousel-media"
                                         onerror="this.src='/images/default-recipe.jpg'">
                                </div>
                            </div>
                            
                            <!-- Controles del carrusel -->
                            <button class="carousel-control prev" id="carouselPrev" aria-label="Anterior">
                                &#10094;
                            </button>
                            <button class="carousel-control next" id="carouselNext" aria-label="Siguiente">
                                &#10095;
                            </button>
                            
                            <!-- Indicadores -->
                            <div class="carousel-indicators" id="carouselIndicators">
                                <span th:each="mediaFile, iterStat : ${receta.mediaFiles}" 
                                      class="indicator"
                                      th:classappend="${iterStat.index == 0} ? 'active' : ''"
                                      th:data-slide="${iterStat.index}"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fallback: Mostrar fotoUrl si no hay mediaFiles (compatibilidad con recetas antiguas) -->
                    <div th:if="${(receta.mediaFiles == null or receta.mediaFiles.isEmpty()) and receta.fotoUrl != null}" class="receta-imagen-principal">
                        <!-- Mostrar video si el tipo es video -->
                        <video th:if="${receta.mediaType == 'video'}" 
                               th:src="${receta.fotoUrl}" 
                               controls 
                               class="receta-video">
                            Tu navegador no soporta el elemento de video.
                        </video>
                        
                        <!-- Mostrar imagen si el tipo es image o no est√° definido -->
                        <img th:if="${receta.mediaType == null or receta.mediaType == 'image'}"
                             th:src="${receta.fotoUrl}" 
                             th:alt="${receta.nombre}"
                             onerror="this.src='/images/default-recipe.jpg'">
                    </div>
                </div>

                <!-- Descripci√≥n -->
                <div class="receta-descripcion" th:if="${receta.descripcion}">
                    <p th:text="${receta.descripcion}">Descripci√≥n de la receta</p>
                </div>

                <!-- Informaci√≥n r√°pida -->
                <div class="receta-quick-info">
                    <div class="info-card">
                        <div class="info-icon">‚è±Ô∏è</div>
                        <div class="info-content">
                            <h4>Tiempo de Preparaci√≥n</h4>
                            <p><span th:text="${receta.tiempoPreparacion}">30</span> minutos</p>
                        </div>
                    </div>
                    <div class="info-card">
                        <div class="info-icon">üë•</div>
                        <div class="info-content">
                            <h4>Porciones</h4>
                            <p><span th:text="${receta.porciones}">4</span> personas</p>
                        </div>
                    </div>
                    <div class="info-card">
                        <div class="info-icon">üìä</div>
                        <div class="info-content">
                            <h4>Dificultad</h4>
                            <p th:text="${receta.dificultad}">Intermedio</p>
                        </div>
                    </div>
                </div>

                <!-- Contenido principal -->
                <div class="receta-contenido">
                    
                    <!-- Ingredientes -->
                    <div class="receta-ingredientes">
                        <h2>ü•ò Ingredientes</h2>
                        <div class="ingredientes-content">
                            <pre th:text="${receta.ingredientes}">
- 2 tazas de harina
- 1 taza de az√∫car
- 3 huevos
                            </pre>
                        </div>
                    </div>

                    <!-- Instrucciones -->
                    <div class="receta-instrucciones">
                        <h2>üìù Instrucciones de Preparaci√≥n</h2>
                        <div class="instrucciones-content">
                            <pre th:text="${receta.instrucciones}">
1. Precalentar el horno a 180¬∞C
2. Mezclar los ingredientes secos
3. Agregar los huevos uno por uno
                            </pre>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n adicional -->
                <div class="receta-info-adicional">
                    <div class="info-box">
                        <h3>üìå Consejos</h3>
                        <ul>
                            <li>Lee toda la receta antes de comenzar</li>
                            <li>Prepara todos los ingredientes con anticipaci√≥n</li>
                            <li>Ajusta las cantidades seg√∫n tus necesidades</li>
                        </ul>
                    </div>
                </div>

                <!-- Compartir en redes sociales -->
                <div class="social-share">
                    <h3>üîó Compartir esta receta</h3>
                    <div class="share-buttons">
                        <button class="share-btn facebook" title="Compartir en Facebook">
                            üìò Facebook
                        </button>
                        <button class="share-btn twitter" title="Compartir en Twitter">
                            üê¶ Twitter
                        </button>
                        <button class="share-btn whatsapp" title="Compartir en WhatsApp">
                            üí¨ WhatsApp
                        </button>
                        <button class="share-btn pinterest" title="Compartir en Pinterest">
                            üìå Pinterest
                        </button>
                        <button class="share-btn copy-link" title="Copiar enlace">
                            üîó Copiar enlace
                        </button>
                    </div>
                </div>

                <!-- Valoraciones -->
                <div class="valoraciones-section">
                    <h3>‚≠ê Valoraci√≥n de la Receta</h3>
                    
                    <div class="valoracion-promedio">
                        <div class="stars-large">
                            <span th:text="${#numbers.formatDecimal(promedioValoracion, 1, 1)}">0.0</span>
                            <div class="stars">
                                <span th:each="i : ${#numbers.sequence(1, 5)}" 
                                      th:class="${i <= promedioValoracion} ? 'star filled' : 'star'">‚òÖ</span>
                            </div>
                            <p><span th:text="${totalValoraciones}">0</span> valoraciones</p>
                        </div>
                    </div>

                    <!-- Formulario de valoraci√≥n -->
                    <div class="valoracion-form">
                        <h4>¬øQu√© te pareci√≥ esta receta?</h4>
                        <form th:action="@{/recetas/detalle/{id}/valorar(id=${receta.id})}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <div class="star-rating">
                                <input type="radio" id="star5" name="estrellas" value="5" 
                                       th:checked="${valoracionUsuario != null && valoracionUsuario.estrellas == 5}">
                                <label for="star5" title="5 estrellas">‚òÖ</label>
                                
                                <input type="radio" id="star4" name="estrellas" value="4"
                                       th:checked="${valoracionUsuario != null && valoracionUsuario.estrellas == 4}">
                                <label for="star4" title="4 estrellas">‚òÖ</label>
                                
                                <input type="radio" id="star3" name="estrellas" value="3"
                                       th:checked="${valoracionUsuario != null && valoracionUsuario.estrellas == 3}">
                                <label for="star3" title="3 estrellas">‚òÖ</label>
                                
                                <input type="radio" id="star2" name="estrellas" value="2"
                                       th:checked="${valoracionUsuario != null && valoracionUsuario.estrellas == 2}">
                                <label for="star2" title="2 estrellas">‚òÖ</label>
                                
                                <input type="radio" id="star1" name="estrellas" value="1"
                                       th:checked="${valoracionUsuario != null && valoracionUsuario.estrellas == 1}">
                                <label for="star1" title="1 estrella">‚òÖ</label>
                            </div>
                            <button type="submit" class="btn btn-primary">Valorar</button>
                        </form>
                        <p th:if="${valoracionUsuario != null}" class="valoracion-actual">
                            Tu valoraci√≥n actual: <span th:text="${valoracionUsuario.estrellas}">0</span> estrellas
                        </p>
                    </div>
                </div>

                <!-- Comentarios -->
                <div class="comentarios-section">
                    <h3>üí¨ Comentarios (<span th:text="${totalComentarios}">0</span>)</h3>
                    
                    <!-- Formulario para nuevo comentario -->
                    <div class="nuevo-comentario">
                        <h4>Deja tu comentario</h4>
                        <form th:action="@{/recetas/detalle/{id}/comentario(id=${receta.id})}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <textarea name="texto" rows="4" placeholder="Escribe tu comentario aqu√≠..." 
                                      required maxlength="1000"></textarea>
                            <button type="submit" class="btn btn-primary">Publicar Comentario</button>
                        </form>
                    </div>

                    <!-- Lista de comentarios -->
                    <div class="comentarios-lista">
                        <div th:if="${comentarios.isEmpty()}" class="no-comentarios">
                            <p>A√∫n no hay comentarios. ¬°S√© el primero en comentar!</p>
                        </div>
                        
                        <div th:each="comentario : ${comentarios}" class="comentario">
                            <div class="comentario-header">
                                <span class="comentario-autor" th:text="${comentario.usuario.username}">Usuario</span>
                                <span class="comentario-fecha" 
                                      th:text="${#temporals.format(comentario.fechaCreacion, 'dd/MM/yyyy HH:mm')}">
                                    01/01/2024 12:00
                                </span>
                            </div>
                            <div class="comentario-texto">
                                <p th:text="${comentario.texto}">Texto del comentario</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Acciones -->
                <div class="receta-acciones">
                    <a th:href="@{/recetas/buscar}" class="btn btn-secondary receta-btn-normal">‚Üê Volver a B√∫squeda</a>
                    <a th:href="@{/}" class="btn btn-secondary receta-btn-normal">üè† Ir al Inicio</a>
                    <!-- Bot√≥n eliminar solo para el autor -->
                    <form th:if="${receta.autor != null} and ${#authentication.principal.username == receta.autor.username}" th:action="@{/recetas/detalle/{id}/eliminar(id=${receta.id})}" method="post" style="display:inline;" id="formEliminarReceta">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="button" class="btn btn-danger receta-btn-eliminar" id="btnEliminarReceta">Eliminar Receta</button>
                        <!-- Modal de confirmaci√≥n -->
                        <div id="modalEliminar" class="modal-eliminar">
                            <div class="modal-content-eliminar">
                                <h3>¬øEliminar receta?</h3>
                                <p>Esta acci√≥n no se puede deshacer.<br>¬øEst√°s seguro?</p>
                                <button type="submit" class="btn btn-danger receta-btn-eliminar-confirm">S√≠, eliminar</button>
                                <button type="button" class="btn btn-secondary receta-btn-cancelar" id="btnCancelarEliminar">Cancelar</button>
                            </div>
                        </div>
                    </form>
                    <!-- Estilos y scripts movidos a archivos externos para CSP -->
                </div>

            </div>
        </div>
    </section>

    <!-- Nota de seguridad (visible solo para el desarrollador) -->
    <div class="dev-note" sec:authorize="isAuthenticated()">
        <p>üîí Esta p√°gina est√° protegida. Solo usuarios autenticados pueden verla.</p>
        <p>Usuario actual: <span sec:authentication="name">usuario</span></p>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Recetas Seguras - Todos los derechos reservados</p>
            <p>Desarrollado con Spring Boot, Spring Security y Thymeleaf</p>
        </div>
    </footer>

    <!-- Script para el dropdown -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dropdown script loaded');
            const dropdown = document.querySelector('.dropdown');
            const dropbtn = document.querySelector('.dropbtn');
            
            console.log('Dropdown element:', dropdown);
            console.log('Dropbtn element:', dropbtn);
            
            if (dropdown && dropbtn) {
                console.log('Dropdown elements found, attaching listeners');
                
                // Toggle dropdown al hacer click en el bot√≥n
                dropbtn.addEventListener('click', function(e) {
                    console.log('Dropdown button clicked');
                    e.preventDefault();
                    e.stopPropagation();
                    dropdown.classList.toggle('active');
                    console.log('Dropdown active state:', dropdown.classList.contains('active'));
                });
                
                // Cerrar dropdown al hacer click fuera
                document.addEventListener('click', function(e) {
                    if (!dropdown.contains(e.target)) {
                        dropdown.classList.remove('active');
                        console.log('Dropdown closed by outside click');
                    }
                });
                
                // Cerrar dropdown al presionar Escape
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        dropdown.classList.remove('active');
                        console.log('Dropdown closed by ESC key');
                    }
                });
            } else {
                console.error('Dropdown elements not found!');
            }
        });
    </script>

    <!-- Script externo para el modal de eliminaci√≥n (cumple con CSP) -->
    <script th:src="@{/js/receta-modal.js}"></script>

    <!-- Script externo para el carrusel (cumple con CSP) -->
    <script th:src="@{/js/carousel.js}"></script>

    <!-- Script externo para compartir en redes sociales (cumple con CSP) -->
    <script th:src="@{/js/social-share.js}"></script>
</body>
</html>

